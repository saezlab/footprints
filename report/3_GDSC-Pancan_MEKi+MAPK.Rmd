---
title: "Pan-cancer improvements with mutations and MAPK scores"
author: "Michael Schubert (schubert@ebi.ac.uk)"
---

```{r code, include=FALSE}
library(dplyr)
b = import('base')
io = import('io')
ar = import('array')
st = import('stats')
df = import('data_frame')
plt = import('plot')
gdsc = import('data/gdsc')
util = import('../analyses/drug_assocs_followup/util')

INFILE = commandArgs(TRUE)[1] %or% "../scores/gdsc/speed_matrix.RData"
OUTFILE = commandArgs(TRUE)[2] %or% "Pancan_assocs.pdf"

tissues = gdsc$tissues()
Ys = gdsc$drug_response('IC50s')
scores = io$load(INFILE)
mut = gdsc$mutated_genes(intogen=TRUE)
ar$intersect(tissues, Ys, scores, mut, along=1)

nst = function(x) names(x[x])

# prepare stratifications of MAPK pathway
drug = "Trametinib" # "(5Z)-7-Oxozeaenol", "RDEA119"

mapk = scores[names(tissues), "MAPK"]
has_mut = mut[,"BRAF"] | mut[,"KRAS"] | mut[,"NRAS"]
path_active = mapk > quantile(mapk)[4] # top 25%
path_inactive = mapk < quantile(mapk)[2] # bottom 25%
path_null = mapk > quantile(mapk)[2] & mapk < quantile(mapk)[4] # rest

pancan = list(
    # stratification by mutation
    "MAPK_all" = nst(!is.na(mapk)),
    "MAPK_wt" = nst(!has_mut),
    "MAPK_mut" = nst(has_mut),

    # stratification by SPEED score
    "MAPK+" = nst(path_active),
    "MAPK-" = nst(path_inactive),
    "MAPK_null" = nst(path_null),

    # stratification by SPEED score, wild-type subset
#    "MAPK+_wt" = nst(!has_mut & (path_active | path_null)),
#    "MAPK-_wt" = nst(!has_mut & path_inactive),

    # stratification by SPEED score, mutated subset
    "MAPK+_mut" = nst(has_mut & path_active),
    "MAPK-_mut" = nst(has_mut & (path_inactive | path_null))
)
```

# Trametinib + MAPK

```{r tram}
mydf = stack(pancan)
mydf$tissue = gdsc$tissues()[mydf$values]
mydf$resp = gdsc$drug_response()[,'Trametinib'][mydf$values]
mut = gdsc$mutated_genes()[,c("KRAS","NRAS","BRAF")]
mydf$mut = ar$map(mut, along=2, function(x) colnames(mut)[x][1])[mydf$values]
mydf$mut[is.na(mydf$mut)] = "wt"
#TODO: the above drops a 2nd mut if avail

mydf$ind = factor(mydf$ind, levels=c("MAPK_all", "MAPK_wt", "MAPK_mut", "MAPK+_mut", "MAPK-_mut", "MAPK+", "MAPK_null", "MAPK-"))

ggplot(mydf, aes(x=ind, y=resp)) +
    geom_violin() +
    geom_boxplot(width=.5, outlier.shape=NA) +
#    geom_boxplot(outlier.shape=NA) +
#    geom_point(aes(colour=tissue, shape=mut), size=5, alpha=0.5, position=position_jitter(w=0.5))
    theme_bw()
```

# Comparing associations to mutations

<!--

for a cutoff, e.g. 5% FDR show how many assocs we get for
- mutations alone
- speed along
- both

maybe split by MEK/MAPK and everything
-->
